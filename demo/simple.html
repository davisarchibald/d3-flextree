<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      body {
        margin: 20px;
      }
    </style>
  </head>
  <body>

    <svg xmlns='http://www.w3.org/2000/svg'
         width='600' height='300'
         border='2'>
      <rect x='0' y='0' width='600' height='300' rx='5' ry='5'
        fill='none' stroke='grey' stroke-width='2' />
      <g id='canvas'
         transform='translate(10, 150)'>
        <!-- rect x='0' y='-50' width='100' height='100' rx='5' ry='5'/ -->
      </g>
    </svg>


    <script src="../build/d3-flextree.js"></script>
    <script>
      const canvas = document.getElementById('canvas');

      // Attributes that are set with every box
      const boxAttrs = {
        fill: '#EEE', stroke: 'blue', 'stroke-width': 2,
        rx: 5, ry: 5,
      };

      // Draw a node; uses plain JavaScript
      function drawNode(wnode) {
        const node = wnode.data;
        //console.log('node x: ' + node.x + ', y: ' + node.y);
        const size = nodeSize(node);
        const box = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        const attrs = merge({}, boxAttrs, {
          x: node.y,
          y: node.x - size[0]/2 + 2.5,
          width: size[1] - 5,
          height: size[0] - 5,
        });
        Object.keys(attrs).forEach(key =>
          box.setAttribute(key, attrs[key]));
        canvas.appendChild(box);
      }


      // Simple tree
      const treeData0 = {
        name: 'root',
        children: [
          { name: 'kid0',
            children: [
              { name: 'gkid-0a' },
              { name: 'gkid-0b' }
          ]},
          { name: 'kid1',
            children: [
              { name: 'gkid-1a' },
              { name: 'gkid-1b' }
          ]},
          { name: 'kid2',
            children: [
              { name: 'gkid-2a' },
              { name: 'gkid-2b' }
          ]},
        ]
      };

      // Node sizes
      const sizes = {
        root: [ 30, 20 ],
        kid0: [ 40, 70 ],
        'gkid-0a': [ 50, 60 ],
        'gkid-0b': [ 50, 100 ],
        kid1: [ 20, 140 ],
        'gkid-1a': [ 50, 60 ],
        'gkid-1b': [ 50, 60 ],
        kid2: [ 50, 60 ],
        'gkid-2a': [ 50, 60 ],
        'gkid-2b': [ 50, 60 ],
      };

      // Function to fetch a node's size
      function nodeSize(node) {
        const size = sizes[node.name];
      /*
        console.log('nodeSize(' + node.name + '), returning ' +
          size[0] + ", " + size[1]);
        console.log('getting size for node ' + node.name);
      */
        return sizes[node.name];
      };

      // Create the layout engine and do the layout
      const flextree = d3.flextree;
      const engine = flextree().nodeSize(nodeSize);
      engine.spacing(function(a, b) { return 0; });;
      const tree = engine(treeData0);
      //console.log('tree: ', tree);

      //drawNode(tree);

      // turn that into an array of nodes, and draw them
      const nodes = d3.flextree.hierarchy(tree).descendants();
      //console.log('nodes: ', nodes);
      nodes.forEach(drawNode);

      // Helpers

      // Merge a set of objects into the leftmost one
      function merge(ref, ...obj) {
        Object.keys(obj[0]).forEach(k => {ref[k] = obj[0][k]});
        if (obj.length == 1) return ref;
        return merge(...obj);
      }

    </script>
  </body>
</html>
